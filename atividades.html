<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atividades de Marketing - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .traffic-light {
            width: 25px; height: 23px; border-radius: 50%; cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 9px;
            font-weight: 800;
            text-shadow: 0 0 2px rgba(0,0,0,0.7);
        }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }

        
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
        /* Ícone de visibilidade para ocultar/mostrar rapidamente */
        .visibility-toggle {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            z-index: 10; 
            transition: background-color 0.2s;
        }
        .visibility-toggle:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .event-card, .event-card-match, .alt-date-card, .event-card-esport, .event-card-campaign, .event-card-crm {
            cursor: pointer;
        }
        #undo-button:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            color: #6b7280;
        }
        .dragging {
            cursor: grabbing;
            cursor: -webkit-grabbing;
            user-select: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div id="page-loader" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        <p class="mt-4 text-lg text-gray-600">A carregar os jogos...</p>
        <div class="w-64 bg-gray-300 rounded-full h-2.5 mt-4">
            <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="mt-2 text-sm font-medium text-gray-600">0%</p>
    </div>

    <header class="bg-white shadow-md fixed w-full top-0 z-30 transition-transform duration-300 ease-in-out">
        <div class="container mx-auto px-6 py-1 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://placehold.co/100x40/000000/FFFFFF?text=H2BET" alt="Logo H2BET" class="h-8">
            </div>
            <nav class="flex space-x-2">
                <a href="index.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Home</a>
                <a href="atividades.html" class="px-4 py-1 bg-gray-700 text-white rounded-md text-sm font-medium">Atividades</a>
				<a href="calendario.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Calendario</a>
				<a href="gantt.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Gantt</a>
                <a href="promocoes.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Promoções</a>
			</nav>
        </div>
    </header>

    <div id="main-content" class="hidden">
        <main id="main-container" class="container mx-auto px-6 py-4">
            
            <section id="esports-matches" class="mb-6">
                <div class="flex items-center">
                    <div class="w-24 flex-shrink-0 pr-2">
                        <h2 class="text-xs font-semibold text-gray-600">Partidas E-Sports</h2>
                        <div class="flex text-yellow-400 text-xs">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                    </div>
                    <div id="esports-matches-container" class="flex-grow flex space-x-1 overflow-x-auto custom-scrollbar pb-4">
                        </div>
                </div>
            </section>

            <section id="crm" class="mb-6">
                <div class="flex items-center">
                    <div class="w-24 flex-shrink-0 pr-2">
                        <h2 class="text-xs font-semibold text-gray-600">CRM</h2>
                        <div class="flex text-yellow-400 text-xs">
                            <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                        </div>
                    </div>
                    <div id="crm-container" class="flex-grow flex space-x-2 overflow-x-auto custom-scrollbar pb-4">
                        </div>
                </div>
            </section>

        </main>
    </div>

    <div id="edit-mode-log" class="hidden fixed bottom-20 right-5 bg-gray-200 text-gray-800 p-3 rounded-lg shadow-xl z-50 transition-transform duration-300 translate-y-24 max-w-xs w-full">
        <p class="text-sm font-semibold mb-2 flex justify-between items-center">
            <span>Última Alteração</span>
            <button id="undo-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-xs transition-colors" disabled>
                <i class="fas fa-undo mr-1"></i>Desfazer
            </button>
        </p>
        <div id="edit-log-content" class="text-xs font-mono bg-gray-100 p-2 rounded-md">Nenhuma alteração registrada.</div>
        <button id="clear-cache-button" class="mt-3 w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-md text-sm transition-colors">
            <i class="fas fa-broom mr-2"></i>Limpar Cache e Dados
        </button>
    </div>


    <div id="edit-mode-toast" class="hidden fixed bottom-5 right-5 bg-blue-600 text-white py-2 px-5 rounded-lg shadow-xl z-50 transition-transform duration-300 translate-y-20 flex items-center gap-2">
        <i class="fas fa-pencil-alt"></i>
        Modo de Edição Ativado.
    </div>

    <div id="generic-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-2">Editar Evento / Partida</h3>
            <p id="event-name-in-modal" class="text-sm text-gray-600 mb-4 truncate"></p>

            <div class="space-y-4">
                <div>
                    <label for="generic-date-input" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="generic-date-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="generic-time-input" class="block text-sm font-medium text-gray-700 mb-1">Horário</label>
                    <input type="time" id="generic-time-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="generic-sash-select" class="block text-sm font-medium text-gray-700 mb-1">Faixa / Tipo</label>
                    <select id="generic-sash-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">Nenhuma</option>
                        <option value="INICIO">Início</option>
                        <option value="FINAL">Final</option>
                        <option value="SEMI_FINAL">Semifinal</option>
                        <option value="QUARTAS_FINAL">Quartas</option>
                        <option value="GALO">GALO</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-generic-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="save-generic-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar Alterações</button>
            </div>
        </div>
    </div>
    
    <div id="alt-date-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Editar Data Alternativa</h3>
            <div class="space-y-4">
                <div>
                    <label for="alt-date-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nome do Evento</label>
                    <input type="text" id="alt-date-name-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="alt-date-date-input" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                    <input type="date" id="alt-date-date-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="alt-date-image-input" class="block text-sm font-medium text-gray-700 mb-1">URL da Imagem</label>
                    <input type="text" id="alt-date-image-input" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-alt-date-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="save-alt-date-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar Alterações</button>
            </div>
        </div>
    </div>


    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyB6zquSsTLCnJ_1WWQm8kb-HkpipU8PrTA",
        authDomain: "marketing-esportivo.firebaseapp.com",
        projectId: "marketing-esportivo",
        storageBucket: "marketing-esportivo.appspot.com",
        messagingSenderId: "53646634690",
        appId: "1:53646634690:web:3e45f49d82d64601c0555b"
    };

    const API_KEY = '373862';
    const BASE_URL = `https://www.thesportsdb.com/api/v1/json/${API_KEY}`;

    let db;
    let allEvents = new Map();
    let isEditModeEnabled = false;
    let editHistory = [];

    const IMPORTANT_LEAGUES = { '4351': 'https://www.thesportsdb.com/images/media/league/badge/ny47lx1701964009.png', '4331': 'https://upload.wikimedia.org/wikipedia/pt/f/f9/Bundesliga_logo_%282017%29.png', '4335': 'https://www.thesportsdb.com/images/media/league/badge/7onmyv1534768460.png', '4328': 'https://footballgroundguide.com/app/uploads/2023/12/premiereleague-logo-768x768.png', '4480': 'https://ssl.gstatic.com/onebox/media/sports/logos/YijZbE4UZ_09JrTvBU91fg_64x64.png', '4501': 'https://s3.static.brasilescola.uol.com.br/be/2022/03/taca-da-libertadores.jpg', '4724': 'https://upload.wikimedia.org/wikipedia/pt/thumb/e/e4/Conmebol_Sudamericana_logo.png/428px-Conmebol_Sudamericana_logo.png', '4443': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQfDSkxta9cASfWZmVMXvVf5L1x-CJTGLGmjYt5GyBC7V01VVoq' };
    const TEAM_LEVELS = { '134465': 5, '134287': 5, '133729': 5, '133739': 5, '133613': 5, '133614': 5, '133668': 5, '133693': 5, '133692': 5, '133689': 5, '133702': 5, '133604': 5, '133612': 5, '133610': 5, '133732': 5, '133667': 5, '134299': 4, '134291': 4, '134284': 4, '134296': 4, '134288': 4, '134281': 4, '133616': 4, '134777': 4, '133671': 4, '133700': 4, '133699': 4, '133695': 4, '133734': 4, '133698': 4, '133696': 4, '133601': 4, '133619': 4, '133690': 4, '134282': 3, '134294': 3, '134286': 3, '134293': 3, '134285': 3, '136186': 3, '133736': 3, '133731': 3, '133735': 3, '133728': 3, '133737': 3, '133694': 3, '133701': 3, '134280': 2, '134744': 2, '134736': 2, '135887': 2, '133636': 2 };
    const MAIN_LEAGUE_IDS = ['4351', '4331', '4335', '4328', '4480', '4501', '4443', '4724'];
    const FOOTBALL_TEAM_IDS = Object.keys(TEAM_LEVELS);
    const UFC_LEAGUE_ID = '4443';
    const GALO_ID = '134299';
    const STATUS_COLORS = { red: '#ef4444', yellow: '#f59e0b', green: '#22c55e' };
    const ESPORTS_IMAGES = {
        'LOL': 'https://cdn1.epicgames.com/offer/24b9b5e323bc40eea252a10cdd3b2f10/EGS_LeagueofLegends_RiotGames_S1_2560x1440-80471666c140f790f28dff68d72c384b',
        'VALORANT': 'https://store-images.s-microsoft.com/image/apps.21507.13663857844271189.4c1de202-3961-4c40-a0aa-7f4f1388775a.20ed7782-0eda-4f9d-b421-4cc47492edc6',
        'R6': 'https://staticctf.ubisoft.com/J3yJr34U2pZ2Ieem48Dwy9uqj5PNUQTn/6CSuHgcdAcvxcEWU6AzJqc/776b4189b4d2d20e87f6c8937374fae7/r6-siege-x-meta-image.jpg'
    };

    function saveDataToCache(eventsMap) {
        const cacheData = {
            timestamp: new Date().toISOString(),
            events: JSON.stringify(Array.from(eventsMap.entries()))
        };
        localStorage.setItem('sportsDashboardCache', JSON.stringify(cacheData));
    }

    function loadDataFromCache() {
        console.log("CACHE DESABILITADO: Forçando a busca de novos dados a cada visita.");
        localStorage.clear();
        sessionStorage.clear();
        clearAllCookies();
        return null; 
    }

    const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

    function clearAllCookies() {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i];
            const eqPos = cookie.indexOf("=");
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = name.trim() + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
        }
        console.log("Cookies do domínio atual foram limpos.");
    }
    
    function clearAllLocalData() {
        console.log("Iniciando limpeza de cache, session storage e cookies...");
        localStorage.removeItem('sportsDashboardCache');
        console.log("Item 'sportsDashboardCache' removido do localStorage.");
        localStorage.clear();
        console.log("localStorage completamente limpo.");
        sessionStorage.clear();
        console.log("sessionStorage completamente limpo.");
        clearAllCookies();
        alert("Cache, Session Storage e Cookies foram limpos! A página será recarregada para aplicar as mudanças.");
        window.location.reload(); 
    }


    function updateProgress(percentage) {
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        if (progressBar && progressText) {
            const p = Math.min(100, Math.max(0, percentage));
            progressBar.style.width = `${p}%`;
            progressText.textContent = `${Math.round(p)}%`;
        }
    }

    async function fetchSheetData() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3rhQxYb78wgVMUssOAdfdaAA8x8jULNsw3PHhhg1vrjPYdfzEKR18DL-o9Z1KJEfyOs4zekgBkQb6/pub?gid=0&single=true&output=csv';
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            csvText.split(/\r?\n/).slice(1).forEach(row => {
                const columns = row.split(',').map(c => c.trim());
                if (columns.length < 5 || !columns[0]) return;
                const [id, name, logo, date, sashType] = columns;
                const dateParts = date.split('/');
                if (dateParts.length !== 3) return;
                const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                processAndAddEvent({
                    idEvent: `sheet_${id}`, strLeague: name, logoUrl: logo, dateEvent: formattedDate,
                    matchType: sashType ? sashType.trim().toUpperCase().replace(/\s+/g, '_') : undefined,
                    isSheetEvent: true, strTime: '', isHidden: false, strEvent: name
                });
            });
        } catch (error) {
            console.error('Erro ao buscar ou processar dados da planilha:', error);
        }
    }

    async function fetchAlternativeDatesData() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3rhQxYb78wgVMUssOAdfdaAA8x8jULNsw3PHhhg1vrjPYdfzEKR18DL-o9Z1KJEfyOs4zekgBkQb6/pub?gid=216139199&single=true&output=csv';
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            csvText.split(/\r?\n/).slice(1).forEach((row, index) => {
                const columns = row.split(',').map(c => c.trim());
                if (columns.length < 3 || !columns[0]) return;
                const [name, date, imageUrl] = columns;
                
                const dateParts = date.split('/');
                if (dateParts.length !== 3) return;
                const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                
                processAndAddEvent({
                    idEvent: `alt_${index}`,
                    strEvent: name,
                    logoUrl: imageUrl,
                    dateEvent: formattedDate,
                    isAlternativeDate: true,
                    strTime: '',
                    isHidden: false,
                    originalStrEvent: name,
                    originalLogoUrl: imageUrl,
                    originalDateEvent: formattedDate
                });
            });
        } catch (error) {
            console.error('Erro ao buscar dados de datas alternativas:', error);
        }
    }
    
    async function fetchEsportsData() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3rhQxYb78wgVMUssOAdfdaAA8x8jULNsw3PHhhg1vrjPYdfzEKR18DL-o9Z1KJEfyOs4zekgBkQb6/pub?gid=1882371884&single=true&output=csv';
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            csvText.split(/\r?\n/).slice(1).forEach((row, index) => {
                const columns = row.split(',').map(c => c.trim());
                if (columns.length < 3 || !columns[0]) return;
                const [dh, partida, esport] = columns;

                const [datePart, timePart] = dh.split(' ');
                if(!datePart || !timePart) return;

                const [day, month, year] = datePart.split('/');
                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                
                const esportKey = esport.toUpperCase();
                
                processAndAddEvent({
                    idEvent: `esport_${index}`,
                    strEvent: partida,
                    eSportType: esportKey,
                    logoUrl: ESPORTS_IMAGES[esportKey] || 'https://placehold.co/600x400/cccccc/ffffff?text=E-Sport',
                    dateEvent: formattedDate,
                    strTime: `${timePart}:00`,
                    isESport: true,
                    isHidden: false
                });
            });
        } catch (error) {
            console.error('Erro ao buscar dados de E-Sports:', error);
        }
    }

    async function fetchCampaignsData() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3rhQxYb78wgVMUssOAdfdaAA8x8jULNsw3PHhhg1vrjPYdfzEKR18DL-o9Z1KJEfyOs4zekgBkQb6/pub?gid=453948170&single=true&output=csv';
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            
            csvText.split(/\r?\n/).slice(1).forEach((row, index) => {
                const columns = row.split(',').map(c => c.trim());
                if (columns.length < 2 || !columns[0] || !columns[1]) return;
                
                const [date, name, type, imageUrl] = columns;
                let finalImageUrl = (imageUrl && imageUrl.startsWith('http')) ? imageUrl : 'https://placehold.co/600x400/cccccc/ffffff?text=Campanha';

                const [day, month, year] = date.split('/');
                if (!day || !month || !year) return;
                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                processAndAddEvent({
                    idEvent: `campaign_${index}`,
                    strEvent: name,
                    logoUrl: finalImageUrl,
                    dateEvent: formattedDate,
                    isCampaign: true,
                    campaignType: type ? type.trim().toUpperCase() : '', 
                    isHidden: false,
                });
            });
        } catch (error) {
            console.error('Erro ao buscar dados de campanhas:', error);
        }
    }

    async function fetchCrmData() {
        const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ3rhQxYb78wgVMUssOAdfdaAA8x8jULNsw3PHhhg1vrjPYdfzEKR18DL-o9Z1KJEfyOs4zekgBkQb6/pub?gid=534833008&single=true&output=csv';
        try {
            const response = await fetch(sheetUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const csvText = await response.text();
            
            csvText.split(/\r?\n/).slice(1).forEach((row, index) => {
                // Alterado para ler 7 colunas. Ajuste o .length se alguma coluna for opcional.
                const columns = row.split(',').map(c => c.trim());
                if (columns.length < 3 || !columns[0] || !columns[1]) return;
                
                // Corresponde a: Evento, Data, Imagem, Bonus, Bonus data inicio, Bonus data fim, canais
                const [name, date, imageUrl, bonus, bonusStart, bonusEnd, channels] = columns;

                let finalImageUrl = (imageUrl && imageUrl.startsWith('http')) ? imageUrl : 'https://placehold.co/600x400/cccccc/ffffff?text=CRM';

                const [day, month, year] = date.split('/');
                if (!day || !month || !year) return;
                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;

                processAndAddEvent({
                    idEvent: `crm_${index}`,
                    strEvent: name,
                    logoUrl: finalImageUrl,
                    dateEvent: formattedDate,
                    isCrm: true, 
                    isHidden: false,
                    // Adicionando os novos dados ao objeto do evento
                    bonus: bonus || '',
                    bonusStart: bonusStart || '',
                    bonusEnd: bonusEnd || '',
                    channels: channels || ''
                });
            });
        } catch (error) {
            console.error('Erro ao buscar dados de CRM:', error);
        }
    }

    function processAndAddEvent(event) {
        if (allEvents.has(event.idEvent)) return;
        event.effectiveDate = event.customDate || event.dateEvent;

        if (event.isCrm) {
            event.importanceScore = 4; // Prioridade do CRM
        } else if (event.isCampaign) {
            event.importanceScore = 5; 
        } else if (event.isAlternativeDate) {
            event.importanceScore = 1; 
        } else if (event.isSheetEvent) {
            event.importanceScore = 10;
        } else if (event.isESport) {
            event.importanceScore = 8;
        } else {
            const homeLevel = TEAM_LEVELS[event.idHomeTeam] || 1;
            const awayLevel = TEAM_LEVELS[event.idAwayTeam] || 1;
            event.importanceScore = homeLevel + awayLevel;
            if (!event.matchType) {
                const leagueNameLower = (event.strLeague || '').toLowerCase();
                const roundNameLower = (event.intRound || '').toString().toLowerCase();
                if (['final', 'cup final', 'world cup', 'decisão'].some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'FINAL';
                else if (['semi-final', 'semifinal'].some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'SEMI_FINAL';
                else if (['quarter-final', 'quarterfinal', 'quartas de final'].some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'QUARTAS_FINAL';
            }
        }
        allEvents.set(event.idEvent, event);
    }

    function getStatusTrafficLights(event) {
        const statuses = event.statuses || { mkt: 'red', crm: 'red', tra: 'red' };
        return ['mkt', 'crm', 'tra'].map(area => `
            <div class="traffic-light"
                 style="background-color: ${STATUS_COLORS[statuses[area]]};"
                 title="${area.toUpperCase()}"
                 data-area="${area}" data-event-id="${event.idEvent}">
                 ${area.toUpperCase()}
            </div>
        `).join('');
    }

    function createVisibilityToggleHTML(event) {
        if (!isEditModeEnabled || event.isAlternativeDate) return '';

        const iconClass = event.isHidden ? 'fa-plus' : 'fa-minus';
        const title = event.isHidden ? 'Mostrar este evento' : 'Ocultar este evento';
        return `
            <div class="visibility-toggle" title="${title}" data-event-id="${event.idEvent}">
                <i class="fas ${iconClass}"></i>
            </div>
        `;
    }

    function createCampaignCard(event) {
        let cardClasses = "bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-36 flex flex-col relative overflow-hidden event-card-campaign";
        if (isEditModeEnabled) cardClasses += " cursor-pointer hover:ring-2 hover:ring-blue-500";

        let typeLabel = '';
        let typeColorClass = '';
        if (event.campaignType === 'INICIO') {
            typeLabel = 'Início';
            typeColorClass = 'text-green-600';
        } else if (event.campaignType === 'FIM') {
            typeLabel = 'Fim';
            typeColorClass = 'text-red-600';
        }

        let dateLabelHtml = '';
        if(typeLabel) {
            dateLabelHtml = `<span class="font-bold ${typeColorClass}">${typeLabel}:</span>`;
        } else {
            dateLabelHtml = `<span class="font-bold text-indigo-600">Data:</span>`;
        }

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                <div class="flex-grow text-center flex flex-col justify-center">
                    <img src="${event.logoUrl}" alt="${event.strEvent}" class="h-12 w-12 object-cover rounded-full mb-2 mx-auto border-2 border-yellow-400">
                    <p class="text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis w-full px-1" title="${event.strEvent}">${event.strEvent}</p>
                </div>
                <div>
                     <p class="text-center text-xs mt-1">
                        ${dateLabelHtml} ${formatDateForCard(event.effectiveDate)}
                     </p>
                    <div class="mt-2 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            </div>
        `;
    }

    function createCrmCard(event) {
        let cardClasses = "bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-36 flex flex-col relative overflow-hidden event-card-crm";
        if (isEditModeEnabled) cardClasses += " cursor-pointer hover:ring-2 hover:ring-purple-500";

        const crmStatus = (event.statuses && event.statuses.crm) || 'red';

        // Cria o HTML para os novos campos se eles existirem
        let bonusHtml = '';
        if (event.bonus && event.bonus.trim() !== '') {
            const tooltipText = `Início: ${event.bonusStart} - Fim: ${event.bonusEnd}`;
            bonusHtml = `<p class="text-xs font-bold text-pink-600 truncate" title="${tooltipText}">${event.bonus}</p>`;
        }

        let channelsHtml = '';
        if (event.channels && event.channels.trim() !== '') {
            // A classe -mt-1 aproxima o canal do bônus
            channelsHtml = `<p class="text-[10px] text-gray-500 -mt-1 truncate">${event.channels}</p>`;
        }

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                <div class="flex-grow text-center flex flex-col justify-center">
                    <img src="${event.logoUrl}" alt="${event.strEvent}" class="h-12 w-12 object-cover rounded-full mb-2 mx-auto border-2 border-purple-400">
                    <p class="text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis w-full px-1" title="${event.strEvent}">${event.strEvent}</p>
                </div>
                <div class="text-center">
                     ${bonusHtml}
                     ${channelsHtml}
                     
                     <p class="text-xs font-bold mt-1 text-indigo-600">
                        ${formatDateForCard(event.effectiveDate)}
                     </p>
                    <div class="mt-2 flex justify-center items-center gap-2 px-1">
                        <div class="traffic-light"
                             style="background-color: ${STATUS_COLORS[crmStatus]};"
                             title="CRM"
                             data-area="crm" data-event-id="${event.idEvent}">
                             CRM
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function createTopEventCard(league, event) {
        const visibilityIconHTML = createVisibilityToggleHTML(event);
        let matchTypeHTML = '';
        if (event.matchType) {
            let matchTypeText = '';
            switch (event.matchType) {
                case 'FINAL': matchTypeText = 'Final'; break;
                case 'SEMI_FINAL': matchTypeText = 'Semifinal'; break;
                case 'QUARTAS_FINAL': matchTypeText = 'Quartas'; break;
                case 'GALO': matchTypeText = 'GALO'; break;
                case 'INICIO': matchTypeText = 'Início'; break;
            }
            if (matchTypeText) {
                matchTypeHTML = `<p class="text-center text-xs font-semibold text-indigo-600">${matchTypeText}</p>`;
            }
        }

        let cardClasses = 'bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-28 flex flex-col event-card relative overflow-hidden transition-opacity duration-300';
        if (isEditModeEnabled) cardClasses += ' cursor-pointer hover:ring-2 hover:ring-blue-500';
        if (!isEditModeEnabled && event.isHidden) cardClasses += ' hidden';
        if (isEditModeEnabled && event.isHidden) cardClasses += ' opacity-50';

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                ${visibilityIconHTML}
                <div class="flex-grow flex flex-col items-center justify-center">
                    <img src="${league.logo}" alt="${league.name}" class="h-10 object-contain" title="${league.name}">
                </div>
                <div>
                    <p class="text-center text-xs font-bold mt-2">${formatDateForCard(event.effectiveDate)}</p>
                    ${matchTypeHTML}
                    <div class="mt-2 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            </div>
        `;
    }

    function createTopMatchCard(event) {
        const visibilityIconHTML = createVisibilityToggleHTML(event);
        let matchTypeHTML = '';
        let matchTypeText = '';

        if (event.matchType) {
            switch (event.matchType) {
                case 'FINAL': matchTypeText = 'Final'; break;
                case 'SEMI_FINAL': matchTypeText = 'Semifinal'; break;
                case 'QUARTAS_FINAL': matchTypeText = 'Quartas'; break;
                case 'INICIO': matchTypeText = 'Início'; break;
                case 'GALO': matchTypeText = 'GALO'; break;
            }
        }
        
        if (matchTypeText) {
            matchTypeHTML = `<p class="text-center text-xs font-semibold text-indigo-700">${matchTypeText}</p>`;
        }

        let cardTopContentHTML = '';
        if (event.idLeague == UFC_LEAGUE_ID) {
            let ufcEventName = (event.strEvent || '').includes(':') ? event.strEvent.split(':')[1].trim() : event.strEvent;
            cardTopContentHTML = `<div class="text-center">
                <img src="https://www.thesportsdb.com/images/media/league/badge/026ms21549488383.png" alt="UFC" class="h-8 mx-auto">
                <p class="text-xs font-bold mt-1.5 truncate" title="${event.strEvent}">${ufcEventName}</p>
            </div>`;
        } else {
             cardTopContentHTML = `<div>
                <div class="flex justify-between items-center text-xs font-semibold text-gray-500 px-1">
                    <span>${event.strLeague}</span>
                </div>
                <div class="flex items-center justify-around my-1.5">
                    <img src="${event.strHomeTeamBadge}" alt="${event.strHomeTeam}" class="h-8 w-8 object-contain">
                    <span class="font-bold text-gray-400 text-sm">vs</span>
                    <img src="${event.strAwayTeamBadge}" alt="${event.strAwayTeam}" class="h-8 w-8 object-contain">
                </div>
            </div>`;
        }
        
        let cardClasses = "bg-white p-1.5 rounded-lg shadow-sm flex-shrink-0 w-44 flex flex-col relative overflow-hidden event-card-match";
        if (isEditModeEnabled) cardClasses += " hover:ring-2 hover:ring-indigo-500";
        if (!isEditModeEnabled && event.isHidden) cardClasses += ' hidden';
        if (isEditModeEnabled && event.isHidden) cardClasses += ' opacity-50';
        
        const effectiveTime = (event.customTime || event.strTime || "00:00:00").substring(0, 5);

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                ${visibilityIconHTML}
                
                <div class="flex-grow">
                    ${cardTopContentHTML}
                </div>

                <div>
                    <div class="flex items-baseline justify-center space-x-2">
                        <p class="text-sm font-bold">${formatDateForCard(event.effectiveDate)}</p>
                        <p class="text-xs text-gray-600">${effectiveTime}</p>
                    </div>
                    ${matchTypeHTML}
                    <div class="mt-1.5 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            </div>
        `;
    }

    function createAlternativeDateCard(event) {
        let cardClasses = "bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-36 flex flex-col relative overflow-hidden alt-date-card";
        if (isEditModeEnabled) cardClasses += " cursor-pointer hover:ring-2 hover:ring-blue-500";

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                <div class="flex-grow text-center flex flex-col justify-center">
                    <img src="${event.logoUrl}" alt="${event.strEvent}" class="h-12 w-12 object-cover rounded-full mb-2 mx-auto border-2 border-gray-200">
                    <p class="text-xs font-semibold whitespace-nowrap overflow-hidden text-ellipsis w-full px-1" title="${event.strEvent}">${event.strEvent}</p>
                </div>
                <div>
                    <p class="text-center text-xs font-bold mt-1 text-indigo-600">${formatDateForCard(event.effectiveDate)}</p>
                    <div class="mt-2 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            </div>
        `;
    }

    function createEsportsMatchCard(event) {
        let cardClasses = "bg-white rounded-lg shadow-sm flex-shrink-0 w-44 flex flex-col relative overflow-hidden event-card-esport";
        if (isEditModeEnabled) cardClasses += " cursor-pointer hover:ring-2 hover:ring-teal-500";
        if (!isEditModeEnabled && event.isHidden) cardClasses += ' hidden';
        if (isEditModeEnabled && event.isHidden) cardClasses += ' opacity-50';

        return `
            <div class="${cardClasses}" data-event-id="${event.idEvent}">
                ${createVisibilityToggleHTML(event)}
                
                <img src="${event.logoUrl}" alt="${event.eSportType}" class="w-full h-16 object-cover">

                <div class="p-2 flex flex-col flex-grow justify-between">
                    <div>
                        <p class="text-sm font-bold text-gray-800 whitespace-normal leading-tight" title="${event.strEvent}">${event.strEvent}</p>
                    </div>

                    <div>
                        <div class="flex items-baseline justify-center space-x-2 mt-1">
                            <p class="text-xs font-bold text-indigo-600">${formatDateForCard(event.effectiveDate)}</p>
                            <p class="text-xs text-gray-500">${event.strTime.substring(0,5)}</p>
                        </div>
                        <div class="mt-2 flex justify-center items-center gap-2">
                            ${getStatusTrafficLights(event)}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function formatDateForCard(dateStr) {
        if (!dateStr) return 'Data indet.';
        const date = new Date(dateStr + 'T00:00:00');
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace('.', '');
    }

    function getSortedEvents() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Define a data para o início do dia (meia-noite) para garantir uma comparação justa.

        // Pega todos os eventos do mapa
        const allCurrentEvents = Array.from(allEvents.values());

        // Filtra para manter apenas os eventos cuja data é maior ou igual a hoje
        const futureEvents = allCurrentEvents.filter(event => {
            // Se um evento não tiver data, ele será removido para segurança
            if (!event.effectiveDate) return false; 
            
            // Cria a data do evento. Adicionar 'T00:00:00' ajuda a evitar problemas com fuso horário
            const eventDate = new Date(event.effectiveDate + 'T00:00:00');
            
            return eventDate >= today;
        });

        // Ordena os eventos futuros do mais próximo para o mais distante
        return futureEvents.sort((a, b) => new Date(a.effectiveDate) - new Date(b.effectiveDate));
    }

    function rerenderAllSections() {
        const sortedEvents = getSortedEvents();
        renderTopEvents(sortedEvents);
        renderTopMatches(sortedEvents);
        renderAlternativeDates(sortedEvents);
        renderEsportsMatches(sortedEvents);
        renderCampaigns(sortedEvents);
        renderCrm(sortedEvents);
        attachAllListeners();
    }

    function renderPage() {
        rerenderAllSections();
        document.getElementById('page-loader').style.display = 'none';
        document.getElementById('main-content').classList.remove('hidden');
        allEvents.forEach(event => listenToEventStatus(event.idEvent));
    }

    function renderCampaigns(events) {
        const container = document.getElementById('campaigns-container');
        if (!container) return;
        container.innerHTML = '';
        let eventsToRender = events.filter(event => event.isCampaign);

        if (eventsToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhuma campanha ativa encontrada.</p>';
        } else {
            container.innerHTML = eventsToRender.map(createCampaignCard).join('');
        }
    }

    function renderCrm(events) {
        const container = document.getElementById('crm-container');
        if (!container) return;
        container.innerHTML = '';
        let eventsToRender = events.filter(event => event.isCrm);

        if (eventsToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhum item de CRM encontrado.</p>';
        } else {
            container.innerHTML = eventsToRender.map(createCrmCard).join('');
        }
    }

    function renderTopEvents(events) {
        const container = document.getElementById('top-events-container');
        if (!container) return;
        container.innerHTML = '';
        let eventsToRender = events.filter(event => event.isSheetEvent).slice(0, 20);

        if (eventsToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhum evento cadastrado no Sheets.</p>';
        } else {
            eventsToRender.forEach(event => {
                const leagueInfo = { id: event.idEvent, name: event.strLeague, logo: event.logoUrl };
                container.innerHTML += createTopEventCard(leagueInfo, event);
            });
        }
    }

    function renderTopMatches(events) {
        const container = document.getElementById('top-matches-container');
        if (!container) return;
        
        const relevantEvents = events.filter(event =>
            event.strLeague &&
            !event.isCampaign &&
            !event.isCrm &&
            !event.strLeague.toLowerCase().includes('friendlies') &&
            !event.strLeague.toLowerCase().includes('amistoso')
        );

        
        const TIER_1_THRESHOLD = 9, TIER_2_THRESHOLD = 7;
        const matchesToDisplayMap = new Map();

        relevantEvents.forEach(event => {
            if (event.idHomeTeam === GALO_ID || event.idAwayTeam === GALO_ID) {
                matchesToDisplayMap.set(event.idEvent, event);
            }
        });
        
        relevantEvents.filter(event => event.matchType && !event.isSheetEvent).forEach(event => matchesToDisplayMap.set(event.idEvent, event));

        let starMatches = [];
        const tier1Matches = relevantEvents.filter(event => !event.isSheetEvent && (event.importanceScore || 0) >= TIER_1_THRESHOLD);
        
        starMatches = (tier1Matches.length > 0) ? tier1Matches : relevantEvents.filter(event => !event.isSheetEvent && (event.importanceScore || 0) >= TIER_2_THRESHOLD);
        
        starMatches.forEach(event => {
            if (!matchesToDisplayMap.has(event.idEvent)) {
                matchesToDisplayMap.set(event.idEvent, event);
            }
        });

        const sortedMatches = Array.from(matchesToDisplayMap.values()).sort((a, b) => new Date(a.effectiveDate) - new Date(b.effectiveDate));
        container.innerHTML = sortedMatches.length > 0 ? sortedMatches.map(createTopMatchCard).join('') : '<p class="text-gray-500">Nenhum jogo de destaque encontrado.</p>';
    }

    function renderAlternativeDates(events) {
        const container = document.getElementById('alternative-dates-container');
        if (!container) return;
        container.innerHTML = '';
        let eventsToRender = events.filter(event => event.isAlternativeDate);

        if (eventsToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhuma data alternativa encontrada.</p>';
        } else {
            container.innerHTML = eventsToRender.map(createAlternativeDateCard).join('');
        }
    }

    function renderEsportsMatches(events) {
        const container = document.getElementById('esports-matches-container');
        if (!container) return;
        container.innerHTML = '';
        let eventsToRender = events.filter(event => event.isESport);

        if (eventsToRender.length === 0) {
            container.innerHTML = '<p class="text-gray-500">Nenhuma partida de e-sport encontrada.</p>';
        } else {
            container.innerHTML = eventsToRender.map(createEsportsMatchCard).join('');
        }
    }

    function attachAllListeners() {
        document.querySelectorAll('.traffic-light').forEach(button => {
            if (button.getAttribute('data-listener-attached')) return;
            button.addEventListener('click', handleTrafficLightClick);
            button.setAttribute('data-listener-attached', 'true');
        });
    }

    async function fetchAllData() {
        updateProgress(0);
        document.getElementById('page-loader').style.display = 'flex';
        document.getElementById('main-content').classList.add('hidden');
        const totalApiSources = MAIN_LEAGUE_IDS.length + FOOTBALL_TEAM_IDS.length;
        let sourcesFetched = 0;
        const updateApiProgress = () => updateProgress(++sourcesFetched / totalApiSources * 80);
        const apiPromises = [];
        MAIN_LEAGUE_IDS.forEach(id => apiPromises.push(fetch(`${BASE_URL}/eventsnextleague.php?id=${id}`).then(res => res.ok ? res.json() : Promise.reject()).then(result => result.events?.forEach(processAndAddEvent)).catch(console.error).finally(updateApiProgress)));
        FOOTBALL_TEAM_IDS.forEach(id => apiPromises.push(fetch(`${BASE_URL}/eventsnext.php?id=${id}`).then(res => res.ok ? res.json() : Promise.reject()).then(result => result.events?.forEach(processAndAddEvent)).catch(console.error).finally(updateApiProgress)));
        await Promise.all(apiPromises);
        
        await fetchSheetData();
        updateProgress(85);
        await fetchAlternativeDatesData();
        updateProgress(88);
        await fetchEsportsData();
        updateProgress(91);
        await fetchCampaignsData();
        updateProgress(94);
        await fetchCrmData();
        updateProgress(96);


    const statusPromises = Array.from(allEvents.keys()).map(eventId => getDoc(doc(db, "event_statuses", eventId)).then(docSnapshot => {
        const event = allEvents.get(eventId);
        if (event) {
            const savedData = docSnapshot.data() || {};
            event.statuses = { mkt: 'red', crm: 'red', tra: 'red', ...savedData };

            if (event.isAlternativeDate) {
                // ... (código existente)
            } else {
                event.matchType = savedData.matchType;
                event.customDate = savedData.customDate;
                event.customTime = savedData.customTime;
                event.effectiveDate = savedData.customDate || event.dateEvent;
                event.isHidden = savedData.isHidden || false;
            }
        }
    }));
    await Promise.all(statusPromises);
        updateProgress(98);
        saveDataToCache(allEvents);
        updateProgress(100);
        await sleep(300);
        renderPage();
    }

    function listenToEventStatus(eventId) {
        onSnapshot(doc(db, "event_statuses", eventId), (docSnapshot) => {
            const event = allEvents.get(eventId);
            if (event) {
                const savedData = docSnapshot.data() || {};
                let needsRerender = false;

                const oldStatusJSON = JSON.stringify(event.statuses);
                event.statuses = { mkt: 'red', crm: 'red', tra: 'red', ...savedData };
                if(JSON.stringify(event.statuses) !== oldStatusJSON) {
                     document.querySelectorAll(`.traffic-light[data-event-id="${eventId}"]`).forEach(light => {
                        const area = light.dataset.area;
                        if (area && event.statuses[area]) {
                            light.style.backgroundColor = STATUS_COLORS[event.statuses[area]];
                        }
                    });
                }

                if (event.isAlternativeDate || event.isCrm) {
                    const newName = savedData.customName || event.originalStrEvent || event.strEvent;
                    const newImageUrl = savedData.customImageUrl || event.originalLogoUrl || event.logoUrl;
                    const newDate = savedData.customDate || event.originalDateEvent || event.dateEvent;
                    if (event.strEvent !== newName || event.logoUrl !== newImageUrl || event.effectiveDate !== newDate) {
                        needsRerender = true;
                        event.strEvent = newName;
                        event.logoUrl = newImageUrl;
                        event.effectiveDate = newDate;
                    }
                } else {
                    const newIsHidden = savedData.isHidden === undefined ? event.isHidden : savedData.isHidden;
                    const newCustomTime = savedData.customTime;

                    if (event.matchType !== savedData.matchType || event.isHidden !== newIsHidden || event.customDate !== savedData.customDate || event.customTime !== newCustomTime) {
                        needsRerender = true;
                    }
                    
                    event.matchType = savedData.matchType;
                    event.customDate = savedData.customDate;
                    event.customTime = newCustomTime;
                    event.effectiveDate = savedData.customDate || event.dateEvent;
                    event.isHidden = newIsHidden;
                }

                if (needsRerender) {
                   rerenderAllSections();
                }
                saveDataToCache(allEvents);
            }
        });
    }

    async function handleTrafficLightClick(e) {
        e.stopPropagation();
        const { eventId, area } = e.currentTarget.dataset;
        if (!eventId || !area) return;

        const event = allEvents.get(eventId);
        const statusCycle = ['red', 'yellow', 'green'];
        const currentStatus = (event?.statuses && event.statuses[area]) || 'red';
        const nextStatus = statusCycle[(statusCycle.indexOf(currentStatus) + 1) % statusCycle.length];

        try {
            await setDoc(doc(db, "event_statuses", eventId), { [area]: nextStatus }, { merge: true });
        } catch (error) {
            console.error("FALHA AO ATUALIZAR O FAROL:", error);
            alert(`ERRO: Não foi possível salvar a alteração do farol.\n\nVerifique sua conexão com a internet ou as regras de segurança do Firebase.\n\nDetalhe do erro: ${error.message}`);
        }
    }
    
    function logChange(eventId, changes, description) {
        editHistory.push({ eventId, changes, description });
        updateEditLogUI();
    }

    function updateEditLogUI() {
        const logContent = document.getElementById('edit-log-content');
        const undoButton = document.getElementById('undo-button');
        if (editHistory.length > 0) {
            const lastAction = editHistory[editHistory.length - 1];
            logContent.textContent = lastAction.description;
            undoButton.disabled = false;
        } else {
            logContent.textContent = "Nenhuma alteração recente.";
            undoButton.disabled = true;
        }
    }

    function toggleEditModeUI(isActive) {
        const toast = document.getElementById('edit-mode-toast');
        const log = document.getElementById('edit-mode-log');
        if (isActive) {
            toast.classList.remove('hidden', 'translate-y-20');
            log.classList.remove('hidden', 'translate-y-24');
            updateEditLogUI();
        } else {
            toast.classList.add('translate-y-20');
            log.classList.add('translate-y-24');
            setTimeout(() => {
                toast.classList.add('hidden');
                log.classList.add('hidden');
            }, 300);
        }
        rerenderAllSections();
    }

    function openGenericEditModal(eventId) {
        const event = allEvents.get(eventId);
        if (!event) return;
        const modal = document.getElementById('generic-edit-modal');
        modal.dataset.editingEventId = eventId;
        document.getElementById('event-name-in-modal').textContent = event.strEvent || `${event.strHomeTeam} vs ${event.strAwayTeam}`;
        document.getElementById('generic-date-input').value = event.effectiveDate;
        document.getElementById('generic-time-input').value = (event.customTime || event.strTime || "").substring(0, 5);
        document.getElementById('generic-sash-select').value = event.matchType || '';
        modal.classList.remove('hidden');
    }

    function openAltDateEditModal(eventId) {
        const event = allEvents.get(eventId);
        if (!event) return;
        const modal = document.getElementById('alt-date-edit-modal');
        modal.dataset.editingEventId = eventId;
        document.getElementById('alt-date-name-input').value = event.strEvent;
        document.getElementById('alt-date-date-input').value = event.effectiveDate;
        document.getElementById('alt-date-image-input').value = event.logoUrl;
        modal.classList.remove('hidden');
    }
    
    async function saveGenericChanges() {
        const modal = document.getElementById('generic-edit-modal');
        const eventId = modal.dataset.editingEventId;
        if (!eventId) return;

        const event = allEvents.get(eventId);
        const newDate = document.getElementById('generic-date-input').value;
        const newTime = document.getElementById('generic-time-input').value;
        const newSash = document.getElementById('generic-sash-select').value || null;
        
        const updates = {};
        const originalTime = (event.strTime || "00:00:00").substring(0, 5);

        if (newDate !== event.dateEvent) updates.customDate = newDate;
        if (newTime && newTime !== originalTime) {
            updates.customTime = newTime + ':00';
        }
        if (newSash !== (event.matchType || null)) updates.matchType = newSash;

        if (Object.keys(updates).length > 0) {
            await setDoc(doc(db, "event_statuses", eventId), updates, { merge: true });
        }
        modal.classList.add('hidden');
    }

    async function saveAltDateChanges() {
        const modal = document.getElementById('alt-date-edit-modal');
        const eventId = modal.dataset.editingEventId;
        if (!eventId) return;
        const event = allEvents.get(eventId);
        
        const newName = document.getElementById('alt-date-name-input').value;
        const newDate = document.getElementById('alt-date-date-input').value;
        const newImageUrl = document.getElementById('alt-date-image-input').value;

        const updates = {};
        updates.customName = (newName !== (event.originalStrEvent || event.strEvent)) ? newName : null;
        updates.customDate = (newDate !== (event.originalDateEvent || event.dateEvent)) ? newDate : null;
        updates.customImageUrl = (newImageUrl !== (event.originalLogoUrl || event.logoUrl)) ? newImageUrl : null;


        await setDoc(doc(db, "event_statuses", eventId), updates, { merge: true });
        modal.classList.add('hidden');
    }

    async function handleUndo() {
        const lastAction = editHistory.pop();
        if (!lastAction) return;

        const { eventId, changes } = lastAction;
        await setDoc(doc(db, "event_statuses", eventId), changes, { merge: true });
        updateEditLogUI();
    }
    
    async function handleVisibilityToggle(eventId) {
        const event = allEvents.get(eventId);
        if (!event) return;
        const newVisibility = !event.isHidden;

        logChange(
            eventId,
            { isHidden: event.isHidden },
            `Visibilidade de "${(event.strEvent || event.strLeague).substring(0, 20)}..." alterada.`
        );

        await setDoc(doc(db, "event_statuses", eventId), { isHidden: newVisibility }, { merge: true });
    }

    async function initialize() {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        await signInAnonymously(auth);
        db = getFirestore(app);

        const header = document.querySelector('header');
        const mainContent = document.getElementById('main-container');
        const adjustMainContentPadding = () => {
            const headerHeight = header.offsetHeight;
            mainContent.style.paddingTop = `${headerHeight}px`;
        };
        adjustMainContentPadding();
        window.addEventListener('resize', adjustMainContentPadding);


        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 'k') {
                e.preventDefault();
                isEditModeEnabled = !isEditModeEnabled;
                toggleEditModeUI(isEditModeEnabled);
            }
        });

        document.getElementById('main-content').addEventListener('click', (e) => {
            if (!isEditModeEnabled) return;

            const visibilityToggle = e.target.closest('.visibility-toggle');
            if (visibilityToggle) {
                e.stopPropagation(); 
                handleVisibilityToggle(visibilityToggle.dataset.eventId);
                return;
            }

            const card = e.target.closest('.event-card, .event-card-match, .alt-date-card, .event-card-esport, .event-card-campaign, .event-card-crm');
            if (card && card.dataset.eventId) {
                const event = allEvents.get(card.dataset.eventId);
                if (event) {
                    if (event.isAlternativeDate || event.isCrm) {
                        openAltDateEditModal(event.idEvent);
                    } else if (event.isCampaign) {
                        console.log("Clicou na campanha:", event.strEvent)
                    } else {
                        openGenericEditModal(event.idEvent);
                    }
                }
            }
        });
        
        document.getElementById('save-generic-btn').addEventListener('click', saveGenericChanges);
        document.getElementById('cancel-generic-btn').addEventListener('click', () => document.getElementById('generic-edit-modal').classList.add('hidden'));
        document.getElementById('save-alt-date-btn').addEventListener('click', saveAltDateChanges);
        document.getElementById('cancel-alt-date-btn').addEventListener('click', () => document.getElementById('alt-date-edit-modal').classList.add('hidden'));
        document.getElementById('undo-button').addEventListener('click', handleUndo);
        document.getElementById('clear-cache-button').addEventListener('click', clearAllLocalData);

        const cachedEvents = loadDataFromCache();
        if (cachedEvents?.size > 0) {
            allEvents = cachedEvents;
            allEvents.forEach(e => e.effectiveDate = e.customDate || e.dateEvent);
            renderPage();
        } else {
            fetchAllData();
        }
        
        const addDragScroll = (element) => {
            if (!element) return;
            let isDown = false, startX, scrollLeft;
            element.addEventListener('mousedown', (e) => { isDown = true; element.classList.add('dragging'); startX = e.pageX - element.offsetLeft; scrollLeft = element.scrollLeft; });
            element.addEventListener('mouseleave', () => { isDown = false; element.classList.remove('dragging'); });
            element.addEventListener('mouseup', () => { isDown = false; element.classList.remove('dragging'); });
            element.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - element.offsetLeft; const walk = (x - startX) * 2; element.scrollLeft = scrollLeft - walk; });
        };
        
        addDragScroll(document.getElementById('top-events-container'));
        addDragScroll(document.getElementById('top-matches-container'));
        addDragScroll(document.getElementById('alternative-dates-container'));
        addDragScroll(document.getElementById('esports-matches-container'));
        addDragScroll(document.getElementById('campaigns-container'));
        addDragScroll(document.getElementById('crm-container'));
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>