<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Marketing Esportivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .traffic-light { 
            width: 18px; height: 18px; border-radius: 50%; cursor: pointer; 
            transition: all 0.2s;
        }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #e2e8f0; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #94a3b8; border-radius: 20px; }
        
        .sash {
            position: absolute; top: 12px; right: -30px;
            transform: rotate(45deg); padding: 2px 30px;
            color: white; font-size: 10px; font-weight: bold;
            text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            text-transform: uppercase; z-index: 1;
        }
        #progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="page-loader" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        <p class="mt-4 text-lg text-gray-600">A carregar os jogos...</p>
        <div class="w-64 bg-gray-300 rounded-full h-2.5 mt-4">
            <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
        </div>
        <p id="progress-text" class="mt-2 text-sm font-medium text-gray-600">0%</p>
    </div>


    <div id="main-content" class="hidden">
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <img src="https://placehold.co/100x40/000000/FFFFFF?text=H2BET" alt="Logo H2BET" class="h-10">
                </div>
                <nav class="flex space-x-2">
                    <button class="px-4 py-2 bg-gray-700 text-white rounded-md text-sm font-medium hover:bg-gray-800 transition-colors">Home</button>
                    <button class="px-4 py-2 bg-gray-200 text-gray-600 rounded-md text-sm font-medium cursor-not-allowed">Calendar</button>
                    <button class="px-4 py-2 bg-gray-200 text-gray-600 rounded-md text-sm font-medium cursor-not-allowed">Gantt</button>
                </nav>
            </div>
        </header>

        <main class="container mx-auto px-6 py-4">
            <section id="top-events" class="mb-6">
                <div class="flex items-center mb-2">
                    <h2 class="text-xl font-bold text-gray-700 mr-4">Próximos Eventos</h2>
                    <div class="flex text-yellow-400">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                </div>
                <div id="top-events-container" class="flex space-x-4 overflow-x-auto custom-scrollbar pb-4">
                    <p class="loading-message text-gray-500">A procurar eventos importantes...</p>
                </div>
            </section>

            <section id="top-matches" class="mb-6">
                 <div class="flex items-center mb-2">
                    <h2 class="text-xl font-bold text-gray-700 mr-4">Próximos Jogos</h2>
                    <div class="flex text-yellow-400">
                        <i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i>
                    </div>
                </div>
                <div id="top-matches-container" class="flex space-x-4 overflow-x-auto custom-scrollbar pb-4">
                     <p class="loading-message text-gray-500">A procurar jogos 5 estrelas...</p>
                </div>
            </section>

            <section id="week-games">
                <h2 class="text-xl font-bold text-gray-700 mb-2">Jogos da Semana</h2>
                <div id="week-games-container" class="grid grid-cols-1 md:grid-cols-7 gap-4">
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB6zquSsTLCnJ_1WWQm8kb-HkpipU8PrTA",
            authDomain: "marketing-esportivo.firebaseapp.com",
            projectId: "marketing-esportivo",
            storageBucket: "marketing-esportivo.appspot.com",
            messagingSenderId: "53646634690",
            appId: "1:53646634690:web:3e45f49d82d64601c0555b"
        };
        
        const API_KEY = '373862';
        const BASE_URL = `https://www.thesportsdb.com/api/v1/json/${API_KEY}`;
        
        let db;
        let allEvents = new Map();

        const IMPORTANT_LEAGUES = {
            '4351': 'https://www.thesportsdb.com/images/media/league/badge/ny47lx1701964009.png',
            '4331': 'https://upload.wikimedia.org/wikipedia/pt/f/f9/Bundesliga_logo_%282017%29.png',
            '4335': 'https://www.thesportsdb.com/images/media/league/badge/7onmyv1534768460.png',
            '4328': 'https://footballgroundguide.com/app/uploads/2023/12/premiereleague-logo-768x768.png',
            '4480': 'https://ssl.gstatic.com/onebox/media/sports/logos/YijZbE4UZ_09JrTvBU91fg_64x64.png',
            '4501': 'https://s3.static.brasilescola.uol.com.br/be/2022/03/taca-da-libertadores.jpg',
            '4724': 'https://upload.wikimedia.org/wikipedia/pt/thumb/e/e4/Conmebol_Sudamericana_logo.png/428px-Conmebol_Sudamericana_logo.png',
            '4443': 'https://encrypted-tbn2.gstatic.com/images?q=tbn:ANd9GcQfDSkxta9cASfWZmVMXvVf5L1x-CJTGLGmjYt5GyBC7V01VVoq'
        };

        const TEAM_LEVELS = {
            '134465': 5, '134287': 5, '133729': 5, '133739': 5, '133613': 5, '133614': 5, '133668': 5, '133693': 5, '133692': 5, '133689': 5, '133702': 5, '133604': 5, '133612': 5, '133610': 5, '133732': 5, '133667': 5,
            '134299': 4, '134291': 4, '134284': 4, '134296': 4, '134288': 4, '134281': 4, '133616': 4, '134777': 4, '133671': 4, '133700': 4, '133699': 4, '133695': 4, '133734': 4, '133698': 4, '133696': 4, '133601': 4, '133619': 4, '133690': 4,
            '134282': 3, '134294': 3, '134286': 3, '134293': 3, '134285': 3, '136186': 3, '133736': 3, '133731': 3, '133735': 3, '133728': 3, '133737': 3, '133694': 3, '133701': 3,
            '134280': 2, '134744': 2, '134736': 2, '135887': 2, '133636': 2
        };
        const MAIN_LEAGUE_IDS = ['4351', '4331', '4335', '4328', '4480', '4501', '4443', '4724'];
        const FOOTBALL_TEAM_IDS = Object.keys(TEAM_LEVELS);
        const UFC_LEAGUE_ID = '4443';
        const SUDAMERICANA_LEAGUE_ID = '4724';
        const LIBERTADORES_LEAGUE_ID = '4501';
        const CHAMPIONS_LEAGUE_ID = '4480';
        
        const STATUS_COLORS = { red: '#ef4444', yellow: '#f59e0b', green: '#22c55e' };

        const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));

        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            if (progressBar && progressText) {
                const p = Math.min(100, Math.max(0, percentage));
                progressBar.style.width = `${p}%`;
                progressText.textContent = `${Math.round(p)}%`;
            }
        }

        function getStatusTrafficLights(event) {
            const statuses = event.statuses || { produtos: 'red', marketing: 'red', crm: 'red' };
            const areas = [
                { id: 'produtos', name: 'Produtos' },
                { id: 'marketing', name: 'Marketing' },
                { id: 'crm', name: 'CRM' }
            ];

            return areas.map(area => `
                <div class="traffic-light" 
                     style="background-color: ${STATUS_COLORS[statuses[area.id]]};"
                     title="${area.name}"
                     data-area="${area.id}"
                     data-event-id="${event.idEvent}">
                </div>
            `).join('');
        }

        function createTopEventCard(league, event) {
            return `
                <div class="bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-44 event-card">
                    <img src="${league.logo}" alt="${league.name}" class="h-10 mx-auto mb-2 object-contain">
                    <p class="text-xs text-center font-semibold text-gray-600 truncate">${league.name}</p>
                    <p class="text-center text-sm font-bold mt-1">${formatDateForCard(event.dateEvent)}</p>
                    <div class="mt-3 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            `;
        }

        function createTopMatchCard(event) {
            let sashHTML = '';
            if (event.matchType) {
                let sashText = ''; let sashColorClass = '';
                switch (event.matchType) {
                    case 'FINAL': sashText = 'Final'; sashColorClass = 'bg-yellow-500'; break;
                    case 'SEMI_FINAL': sashText = 'Semifinal'; sashColorClass = 'bg-gray-400'; break;
                    case 'QUARTAS_FINAL': sashText = 'Quartas'; sashColorClass = 'bg-yellow-700'; break;
                }
                if (sashText) sashHTML = `<div class="sash ${sashColorClass}">${sashText}</div>`;
            }
            
            const starRatingHTML = `<div class="flex items-center gap-1 text-xs text-gray-600"><i class="fas fa-star text-yellow-500"></i><span class="font-bold">${event.importanceScore || 0}</span></div>`;
            
            let cardContentHTML = '';
            if (event.idLeague == UFC_LEAGUE_ID) {
                let ufcEventName = (event.strEvent || '').includes(':') ? event.strEvent.split(':')[1].trim() : event.strEvent;
                cardContentHTML = `...`; // Omitted for brevity, assumed unchanged
            } else {
                 cardContentHTML = `
                     <div>
                        <div class="flex justify-between items-center text-xs font-semibold text-gray-500 px-1">
                            <span>${event.strLeague}</span>
                            ${starRatingHTML}
                        </div>
                        <div class="flex items-center justify-around my-2">
                            <img src="${event.strHomeTeamBadge}" alt="${event.strHomeTeam}" class="h-10 w-10 object-contain">
                            <span class="font-bold text-gray-400">vs</span>
                            <img src="${event.strAwayTeamBadge}" alt="${event.strAwayTeam}" class="h-10 w-10 object-contain">
                        </div>
                        <div class="text-center">
                            <p class="text-sm font-bold">${formatDateForCard(event.dateEvent)}</p>
                            <p class="text-xs text-gray-600">${event.strTime.substring(0,5)}</p>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-white p-2 rounded-lg shadow-sm flex-shrink-0 w-56 flex flex-col justify-between relative overflow-hidden">
                    ${sashHTML}
                    ${cardContentHTML}
                    <div class="mt-2 flex justify-center items-center gap-2 px-1">
                        ${getStatusTrafficLights(event)}
                    </div>
                </div>
            `;
        }
        
        function createWeekGameItem(event) {
            const isGamified = event.statuses && Object.values(event.statuses).some(s => s !== 'red');
            const isImportant = event.importanceScore >= 7 || event.matchType || event.idLeague == UFC_LEAGUE_ID || event.idLeague == SUDAMERICANA_LEAGUE_ID;
            const shouldShowStar = isImportant || isGamified;
            
            let eventName = (event.idLeague == UFC_LEAGUE_ID) 
                ? ((event.strEvent || '').includes(':') ? event.strEvent.split(':')[1].trim() : event.strEvent)
                : (event.strHomeTeam && event.strAwayTeam ? `${event.strHomeTeam} x ${event.strAwayTeam}` : event.strEvent || '');

            if (!eventName) return '';

            return `
                <div class="flex items-center justify-between py-1">
                    <span class="text-xs text-gray-600 truncate pr-2" title="${event.strEvent}">${eventName}</span>
                    ${shouldShowStar ? '<i class="fas fa-star text-yellow-500 text-xs flex-shrink-0"></i>' : ''}
                </div>
            `;
        }

        function formatDateForCard(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace('.', '');
        }
        
        function renderTopEvents(events) {
            const container = document.getElementById('top-events-container');
            container.innerHTML = '';
            const processedLeagues = new Set();
            events.forEach(event => {
                if (IMPORTANT_LEAGUES[event.idLeague] && !processedLeagues.has(event.idLeague)) {
                    const leagueInfo = { id: event.idLeague, name: event.strLeague, logo: IMPORTANT_LEAGUES[event.idLeague] };
                    container.innerHTML += createTopEventCard(leagueInfo, event);
                    processedLeagues.add(event.idLeague);
                }
            });
        }
        
        function renderTopMatches(events) {
            const container = document.getElementById('top-matches-container');
            const GALO_ID = '134299';
            const TARGET_SIZE = 6;
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const limitDate = new Date();
            limitDate.setDate(today.getDate() + 14);

            const upcomingEvents = events.filter(event => {
                const eventDate = new Date(event.dateEvent + 'T00:00:00');
                return eventDate >= today && eventDate <= limitDate;
            });

            const topMatchesMap = new Map();
            const fiveStarMatches = upcomingEvents.filter(e => e.matchType);
            fiveStarMatches.forEach(match => topMatchesMap.set(match.idEvent, match));

            const nextAlexPereiraFight = upcomingEvents.find(e => e.idLeague == UFC_LEAGUE_ID && (e.strEvent || '').toLowerCase().includes('alex pereira'));
            if (nextAlexPereiraFight) topMatchesMap.set(nextAlexPereiraFight.idEvent, nextAlexPereiraFight);

            const nextGaloMatch = upcomingEvents.find(e => e.idHomeTeam === GALO_ID || e.idAwayTeam === GALO_ID);
            if (nextGaloMatch) topMatchesMap.set(nextGaloMatch.idEvent, nextGaloMatch);
            
            if (topMatchesMap.size < TARGET_SIZE) {
                const sortedByScore = [...upcomingEvents].sort((a, b) => (b.importanceScore || 0) - (a.importanceScore || 0));
                for (const event of sortedByScore) {
                    if (topMatchesMap.size >= TARGET_SIZE) break;
                    if (!topMatchesMap.has(event.idEvent)) topMatchesMap.set(event.idEvent, event);
                }
            }

            const combinedMatches = Array.from(topMatchesMap.values()).sort((a, b) => new Date(a.dateEvent) - new Date(b.dateEvent));
            container.innerHTML = combinedMatches.length > 0 ? combinedMatches.map(createTopMatchCard).join('') : '<p class="text-gray-500">Nenhum próximo jogo importante encontrado.</p>';
        }
        
        function getGamePriorityScore(game) {
            let score = game.importanceScore || 0;
            const isGamified = game.statuses && Object.values(game.statuses).some(s => s !== 'red');
            if (isGamified) score += 100;
            if (game.matchType === 'FINAL') score += 50;
            if (game.matchType === 'SEMI_FINAL') score += 40;
            if (game.matchType === 'QUARTAS_FINAL') score += 30;
            if (game.idLeague == LIBERTADORES_LEAGUE_ID) score += 25;
            if (game.idLeague == CHAMPIONS_LEAGUE_ID) score += 25;
            if (game.idLeague == SUDAMERICANA_LEAGUE_ID) score += 25; 
            if (game.idLeague == UFC_LEAGUE_ID) score += 15;
            return score;
        }

        function renderWeekGames(events) {
            const container = document.getElementById('week-games-container');
            container.innerHTML = '';
            const weekDates = [];
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                weekDates.push(date);
            }

            weekDates.forEach(date => {
                const dateString = date.toISOString().split('T')[0];
                const gamesForDay = events.filter(e => e.dateEvent === dateString);
                const sortedGames = gamesForDay.sort((a, b) => getGamePriorityScore(b) - getGamePriorityScore(a));
                const initialGames = sortedGames.slice(0, 4);
                const hiddenGames = sortedGames.slice(4);
                let gamesHTML = initialGames.map(createWeekGameItem).join('');
                if (hiddenGames.length > 0) {
                    gamesHTML += `<div id="more-games-${dateString}" class="hidden space-y-1 mt-1">${hiddenGames.map(createWeekGameItem).join('')}</div>`;
                    gamesHTML += `<button class="ver-mais-btn text-xs text-blue-500 hover:underline mt-2 w-full text-center" data-target="more-games-${dateString}">Ver mais</button>`;
                }
                if (sortedGames.length === 0) {
                    gamesHTML = '<p class="text-xs text-gray-400">Sem jogos de destaque.</p>';
                }
                container.innerHTML += `<div class="bg-gray-800 p-3 rounded-lg"><h3 class="text-white font-bold text-center mb-2">${date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }).replace('.','')}</h3><div class="bg-white p-2 rounded-md space-y-1 min-h-[100px]">${gamesHTML}</div></div>`;
            });
        }
        
        function attachAllListeners() {
            document.querySelectorAll('.traffic-light').forEach(button => {
                if (button.getAttribute('data-listener-attached')) return;
                button.addEventListener('click', handleTrafficLightClick);
                button.setAttribute('data-listener-attached', 'true');
            });
            document.querySelectorAll('.ver-mais-btn').forEach(button => {
                if (button.getAttribute('data-listener-attached')) return;
                button.addEventListener('click', (e) => {
                    const targetId = e.target.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.classList.toggle('hidden');
                        e.target.textContent = targetElement.classList.contains('hidden') ? 'Ver mais' : 'Ver menos';
                    }
                });
                button.setAttribute('data-listener-attached', 'true');
            });
        }
        
        function processAndAddEvent(event) {
            if (!allEvents.has(event.idEvent)) {
                const homeLevel = TEAM_LEVELS[event.idHomeTeam] || 1;
                const awayLevel = TEAM_LEVELS[event.idAwayTeam] || 1;
                event.importanceScore = homeLevel + awayLevel;
                const leagueNameLower = (event.strLeague || '').toLowerCase();
                const roundNameLower = (event.intRound || '').toString().toLowerCase();
                const finalKeywords = ['final', 'cup final', 'world cup', 'decisão'];
                const semiFinalKeywords = ['semi-final', 'semifinal'];
                const quarterFinalKeywords = ['quarter-final', 'quarterfinal', 'quartas de final'];
                if (finalKeywords.some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'FINAL';
                else if (semiFinalKeywords.some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'SEMI_FINAL';
                else if (quarterFinalKeywords.some(k => leagueNameLower.includes(k) || roundNameLower.includes(k))) event.matchType = 'QUARTAS_FINAL';
                allEvents.set(event.idEvent, event);
            }
        }

        async function fetchAllData() {
            updateProgress(0);

            for (let i = 0; i < MAIN_LEAGUE_IDS.length; i++) {
                try {
                    const response = await fetch(`${BASE_URL}/eventsnextleague.php?id=${MAIN_LEAGUE_IDS[i]}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.events) result.events.forEach(processAndAddEvent);
                    }
                } catch (error) { console.error(`Error fetching for league ${MAIN_LEAGUE_IDS[i]}:`, error); }
                updateProgress(((i + 1) / MAIN_LEAGUE_IDS.length) * 45);
                await sleep(50);
            }

            for (let i = 0; i < FOOTBALL_TEAM_IDS.length; i++) {
                try {
                    const response = await fetch(`${BASE_URL}/eventsnext.php?id=${FOOTBALL_TEAM_IDS[i]}`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.events) result.events.forEach(processAndAddEvent);
                    }
                } catch (error) { console.error(`Error fetching for team ${FOOTBALL_TEAM_IDS[i]}:`, error); }
                updateProgress(45 + (((i + 1) / FOOTBALL_TEAM_IDS.length) * 45));
                await sleep(50);
            }
            
            updateProgress(95);
            const statusPromises = Array.from(allEvents.keys()).map(eventId => {
                return getDoc(doc(db, "event_statuses", eventId)).then(docSnapshot => {
                    const event = allEvents.get(eventId);
                    if (event) {
                        const defaultStatuses = { produtos: 'red', marketing: 'red', crm: 'red' };
                        const savedStatuses = docSnapshot.data() || {};
                        event.statuses = { ...defaultStatuses, ...savedStatuses };
                    }
                });
            });
            await Promise.all(statusPromises);

            updateProgress(98);
            const eventsArray = Array.from(allEvents.values()).sort((a, b) => new Date(a.dateEvent) - new Date(b.dateEvent));
            
            renderTopEvents(eventsArray);
            renderTopMatches(eventsArray);
            renderWeekGames(eventsArray);
            attachAllListeners();

            updateProgress(100);
            await sleep(300);

            document.getElementById('page-loader').style.display = 'none';
            document.getElementById('main-content').classList.remove('hidden');
            
            allEvents.forEach(event => listenToEventStatus(event.idEvent));
        }

        function listenToEventStatus(eventId) {
            onSnapshot(doc(db, "event_statuses", eventId), (docSnapshot) => {
                const event = allEvents.get(eventId);
                if (event) {
                    const defaultStatuses = { produtos: 'red', marketing: 'red', crm: 'red' };
                    const savedStatuses = docSnapshot.data() || {};
                    event.statuses = { ...defaultStatuses, ...savedStatuses };
                    
                    const lights = document.querySelectorAll(`.traffic-light[data-event-id="${eventId}"]`);
                    lights.forEach(light => {
                        const area = light.dataset.area;
                        if (area && event.statuses[area]) {
                            light.style.backgroundColor = STATUS_COLORS[event.statuses[area]];
                        }
                    });
                }
            });
        }

        async function handleTrafficLightClick(e) {
            const { eventId, area } = e.target.dataset;
            if (!eventId || !area) return;

            const event = allEvents.get(eventId);
            const currentStatus = event.statuses[area] || 'red';
            
            const statusCycle = ['red', 'yellow', 'green'];
            const currentIndex = statusCycle.indexOf(currentStatus);
            const nextStatus = statusCycle[(currentIndex + 1) % statusCycle.length];

            const eventDocRef = doc(db, "event_statuses", eventId);
            await setDoc(eventDocRef, { [area]: nextStatus }, { merge: true });
        }
        
        async function initialize() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            fetchAllData();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initialize();
        });
    </script>
</body>
</html>