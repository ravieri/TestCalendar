<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promoções - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        #page-loader { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="page-loader" class="fixed inset-0 bg-gray-100 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-500"></div>
        <p class="mt-4 text-lg text-gray-600">A carregar promoções...</p>
    </div>

    <header class="bg-white shadow-md fixed w-full top-0 z-30">
        <div class="container mx-auto px-6 py-1 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <img src="https://placehold.co/100x40/000000/FFFFFF?text=H2BET" alt="Logo H2BET" class="h-8">
            </div>
            <nav class="flex space-x-2">
    <a href="blackfriday.html" class="px-4 py-1 bg-amber-400 text-gray-800 rounded-md text-sm font-bold hover:bg-amber-500 transition-colors">BLACKFRIDAY</a>
    
    <a href="index.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Home</a>
    <a href="atividades.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Atividades</a>
    <a href="calendario.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Calendario</a>
    <a href="gantt.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Gantt</a>
    <a href="promocoes.html" class="px-4 py-1 bg-gray-200 text-gray-600 rounded-md text-sm font-medium hover:bg-gray-300 transition-colors">Promoções</a>
</nav>
        </div>
    </header>

    <main id="main-container" class="container mx-auto px-6 py-4 invisible">
        <section id="promocoes-section" class="space-y-8">
            <h1 class="text-3xl font-bold text-gray-800 border-b pb-4">Promoções Especiais</h1>

            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-3">M12</h2>
                <div id="m12-container" class="bg-white rounded-lg shadow p-4 space-y-2">
                    <p class="text-gray-500">A carregar...</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-3">Odds 100</h2>
                <div id="odds100-container" class="bg-white rounded-lg shadow p-4 space-y-2">
                     <p class="text-gray-500">A carregar...</p>
                </div>
            </div>

            <div>
                <h2 class="text-2xl font-semibold text-gray-700 mb-3">Super Odds</h2>
                <div id="superodds-container" class="bg-white rounded-lg shadow p-4 space-y-2">
                    <p class="text-gray-500">A carregar...</p>
                </div>
            </div>
        </section>
    </main>

    <script>
        const PROMO_URLS = {
            M12: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJZd6k-3TzPkus3DfjBeVMrG9OHitePd1YBDOpSqiY8s1F6qVcQycyaIF6mI4HcZwyKuM7TvtZBJ28/pub?gid=2095789570&single=true&output=csv',
            ODDS100: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJZd6k-3TzPkus3DfjBeVMrG9OHitePd1YBDOpSqiY8s1F6qVcQycyaIF6mI4HcZwyKuM7TvtZBJ28/pub?gid=1805672846&single=true&output=csv',
            SUPERODDS: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRJZd6k-3TzPkus3DfjBeVMrG9OHitePd1YBDOpSqiY8s1F6qVcQycyaIF6mI4HcZwyKuM7TvtZBJ28/pub?gid=1705488813&single=true&output=csv'
        };

        function parsePromoDateTime(dateTimeString) {
            if (!dateTimeString) return null;
            const parts = dateTimeString.split(' ');
            if (parts.length < 2) return null;
            const dateParts = parts[0].split('/');
            const timeParts = parts[1].split(':');
            if (dateParts.length !== 3 || timeParts.length < 2) return null;
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0], timeParts[0], timeParts[1], timeParts[2] || 0);
        }

        /**
         * Leitor de linha CSV inteligente. Consegue lidar com vírgulas dentro de campos com aspas.
         * @param {string} row - A linha de texto do CSV.
         * @returns {string[]} Um array com as colunas.
         */
        function parseCsvRow(row) {
            const columns = [];
            let currentColumn = '';
            let inQuotes = false;
            for (let i = 0; i < row.length; i++) {
                const char = row[i];
                const nextChar = row[i + 1];

                if (char === '"' && inQuotes && nextChar === '"') { // Lida com aspas duplas "" dentro do texto
                    currentColumn += '"';
                    i++; // Pula a próxima aspa
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    columns.push(currentColumn);
                    currentColumn = '';
                } else {
                    currentColumn += char;
                }
            }
            columns.push(currentColumn);
            return columns;
        }

        async function fetchAndParsePromos(sheetName, url, nameIndex, dateIndex, dateParser) {
            console.log(`--- INICIANDO BUSCA PARA: ${sheetName} ---`);
            try {
                const response = await fetch(url + '&t=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const csvText = await response.text();
                
                const rows = csvText.split(/\r?\n/);
                const dataRows = rows.slice(1);
                const now = new Date();
                
                console.log(`[${sheetName}] Processando ${dataRows.length} linhas de dados...`);
                const processedPromos = dataRows.map((row, i) => {
                    console.log(`[${sheetName}] Lendo linha ${i + 2}: "${row}"`);
                    if (!row) {
                        console.log(` -> Linha vazia, pulando.`);
                        return null;
                    }
                    
                    // Usa o novo leitor de CSV inteligente
                    const columns = parseCsvRow(row);

                    if (columns.length <= Math.max(nameIndex, dateIndex)) {
                        console.warn(` -> AVISO: A linha não tem colunas suficientes. (Total: ${columns.length}, Precisa de: ${Math.max(nameIndex, dateIndex) + 1})`);
                        return null;
                    }

                    const name = columns[nameIndex] ? columns[nameIndex].trim() : '';
                    const dateStr = columns[dateIndex] ? columns[dateIndex].trim() : '';
                    console.log(` -> Dados extraídos: Nome [col ${nameIndex}]: "${name}", Data [col ${dateIndex}]: "${dateStr}"`);

                    if (!name || !dateStr) {
                        console.warn(` -> AVISO: Nome ou data estão vazios, pulando.`);
                        return null;
                    }
                    
                    const result = dateParser(dateStr, now);
                    if (result) {
                        console.log(` -> SUCESSO: Data válida e no futuro. Promoção adicionada.`);
                        return { ...result, name };
                    } else {
                        console.log(` -> FALHA: Data inválida ou no passado. Promoção ignorada.`);
                        return null;
                    }
                }).filter(Boolean);

                console.log(`--- FIM DA BUSCA PARA: ${sheetName}. Total de promoções válidas: ${processedPromos.length} ---`);
                return processedPromos;

            } catch (error) {
                console.error(`Falha CRÍTICA ao buscar promoções de ${sheetName}:`, error);
                return [];
            }
        }
        
        function renderPromotions(containerId, promotions, emptyMessage) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (promotions.length === 0) {
                container.innerHTML = `<p class="text-gray-500 italic">${emptyMessage}</p>`;
                return;
            }

            const promotionsHTML = promotions
                .sort((a, b) => a.date - b.date)
                .map(promo => {
                    const dateText = promo.originalDate 
                        ? promo.originalDate
                        : promo.date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="py-3 px-2 border-b border-gray-100 flex justify-between items-center gap-4 hover:bg-gray-50 rounded-md">
                            <p class="text-base text-gray-800">${promo.name}</p>
                            <p class="text-sm font-semibold text-indigo-600 flex-shrink-0 whitespace-nowrap">${dateText}</p>
                        </div>
                    `;
                }).join('');

            container.innerHTML = promotionsHTML;
        }

        async function initialize() {
            const mainContent = document.getElementById('main-container');
            const header = document.querySelector('header');
            mainContent.style.paddingTop = `${header.offsetHeight + 16}px`;

            // Mapeamento de Letras para Índices (A=0, F=5, G=6, H=7, I=8)
            const m12Promise = fetchAndParsePromos('M12', PROMO_URLS.M12, 6, 7, (dateStr, now) => {
                const promoDate = parsePromoDateTime(dateStr);
                if (promoDate && promoDate > now) return { date: promoDate };
                return null;
            });

            const odds100Promise = fetchAndParsePromos('ODDS100', PROMO_URLS.ODDS100, 5, 6, (dateStr, now) => {
                const promoDate = parsePromoDateTime(dateStr);
                if (promoDate && promoDate > now) return { date: promoDate };
                return null;
            });

            const superOddsPromise = fetchAndParsePromos('SUPERODDS', PROMO_URLS.SUPERODDS, 6, 8, (dateStr, now) => {
                const dateParts = dateStr.split('/');
                if (dateParts.length !== 2) return null;
                const currentYear = new Date().getFullYear();
                const promoDate = new Date(currentYear, dateParts[1] - 1, dateParts[0], 23, 59, 59);
                if (promoDate && promoDate > now) return { date: promoDate, originalDate: dateStr };
                return null;
            });

            const [m12Promotions, odds100Promotions, superOddsPromotions] = await Promise.all([
                m12Promise,
                odds100Promise,
                superOddsPromise
            ]);
            
            renderPromotions('m12-container', m12Promotions, 'Nenhuma promoção M12 ativa no momento.');
            renderPromotions('odds100-container', odds100Promotions, 'Nenhuma promoção Odds 100 ativa no momento.');
            renderPromotions('superodds-container', superOddsPromotions, 'Nenhuma Super Odd ativa no momento.');
            
            const loader = document.getElementById('page-loader');
            loader.style.opacity = '0';
            setTimeout(() => {
                loader.style.display = 'none';
                mainContent.style.visibility = 'visible';
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>